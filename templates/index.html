<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaysia Electricity Generator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Styles personnalis√©s √©pur√©s */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            margin: 2rem auto;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 1200px;
        }
        
        .section-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
        }
        
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-waiting { background-color: #6c757d; }
        .status-loading { 
            background-color: #ffc107; 
            animation: pulse 1.5s infinite;
        }
        .status-success { background-color: #28a745; }
        .status-error { 
            background-color: #dc3545;
            animation: shake 0.5s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .log-container {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .export-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .export-card:hover {
            border-color: #007bff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }
        
        .hidden { display: none; }
        
        .alert {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
        }

        /* Styles cartographie am√©lior√©s */
        #map-container {
            transition: all 0.3s ease;
        }

        #osm-map {
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }

        .building-marker {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            border: 1px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .building-marker.residential { background-color: #28a745; }
        .building-marker.commercial { background-color: #007bff; }
        .building-marker.office { background-color: #6f42c1; }
        .building-marker.industrial { background-color: #fd7e14; }
        .building-marker.school { background-color: #20c997; }
        .building-marker.hospital { background-color: #dc3545; }

        /* Contr√¥les cartographie */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .density-control {
            margin-bottom: 10px;
        }

        .density-slider {
            width: 100%;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- En-t√™te -->
        <div class="text-center mb-4">
            <h1 class="mb-2">üá≤üáæ Malaysia Electricity Generator</h1>
            <p class="lead text-muted">Consommation d'√©lectricit√© et d'eau</p>
            <div class="badge bg-success">Fichiers d'Export Distincts et cartographie Intelligente</div>
        </div>

        <!-- Statut de l'application -->
        <div class="section-card">
            <h5><span class="step-number">i</span>Statut de l'Application</h5>
            <div id="app-status">
                <span class="status-indicator status-loading"></span>
                <span>Initialisation...</span>
            </div>
            <small class="text-muted d-block mt-2">Cache: <span id="cache-info">0 b√¢timents, 0 points</span></small>
        </div>

        <!-- √âtape 1: S√©lection Zone -->
        <div class="section-card">
            <h5><span class="step-number">1</span>S√©lection de la Zone Malaysia</h5>
            <div class="row">
                <div class="col-md-6">
                    <label for="zone-select" class="form-label">Choisir une zone :</label>
                    <select id="zone-select" class="form-select">
                        <option value="">Chargement des zones...</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button id="btn-load-buildings" class="btn btn-primary" disabled>
                        Charger les B√¢timents OSM
                    </button>
                </div>
            </div>
            <div id="buildings-status" class="mt-3 hidden">
                <span class="status-indicator status-waiting"></span>
                <span id="buildings-text">Aucun b√¢timent charg√©</span>
            </div>
            
            <!-- Carte OSM avec contr√¥les intelligents -->
            <div id="map-container" class="mt-4 hidden">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Carte Interactive des B√¢timents</h6>
                    <div>
                        <button id="btn-toggle-map" class="btn btn-outline-secondary btn-sm">
                            Masquer la carte
                        </button>
                        <span class="badge bg-info ms-2" id="map-building-count">0 b√¢timents</span>
                    </div>
                </div>
                
                <div style="position: relative;">
                    <div id="osm-map" style="height: 400px; border-radius: 10px; border: 2px solid #dee2e6;"></div>
                    
                    <!-- Contr√¥les de densit√© -->
                    <div class="map-controls">
                        <div class="density-control">
                            <label class="form-label" style="font-size: 0.8rem; margin-bottom: 2px;">Densit√© d'affichage:</label>
                            <input type="range" class="density-slider" id="density-slider" 
                                   min="1" max="100" value="10" step="1">
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                <span>Min</span>
                                <span id="density-value">10%</span>
                                <span>Max</span>
                            </div>
                        </div>
                        <button id="btn-refresh-map" class="btn btn-sm btn-primary" style="font-size: 0.7rem;">
                            üîÑ Actualiser
                        </button>
                    </div>
                </div>
                
                <small class="text-muted mt-1 d-block">
                    ‚ÑπÔ∏è Carte interactive avec √©chantillonnage intelligent. 
                    Ajustez la densit√© pour voir plus ou moins de b√¢timents.
                </small>
            </div>
        </div>

        <!-- √âtape 2: Configuration G√©n√©ration -->
        <div class="section-card">
            <h5><span class="step-number">2</span>Configuration de G√©n√©ration</h5>
            
            <!-- S√©lection des types de donn√©es -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label"><strong>Types de donn√©es √† g√©n√©rer :</strong></label>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generate-electricity" checked>
                                <label class="form-check-label" for="generate-electricity">
                                    ‚ö° Consommation √âlectrique
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generate-water" checked>
                                <label class="form-check-label" for="generate-water">
                                    üíß Consommation Eau
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generate-weather" checked>
                                <label class="form-check-label" for="generate-weather">
                                    üå§Ô∏è Donn√©es M√©t√©o
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="alert alert-warning p-2 mb-0" style="font-size: 0.85em;">
                                <small>‚ö†Ô∏è Au moins un type requis</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Param√®tres temporels -->
            <div class="row">
                <div class="col-md-3">
                    <label for="start-date" class="form-label">Date d√©but :</label>
                    <input type="date" id="start-date" class="form-control" value="2024-01-01">
                </div>
                <div class="col-md-3">
                    <label for="end-date" class="form-label">Date fin :</label>
                    <input type="date" id="end-date" class="form-control" value="2024-01-07">
                </div>
                <div class="col-md-3">
                    <label for="frequency" class="form-label">Fr√©quence :</label>
                    <select id="frequency" class="form-select">
                        <option value="15T">15 minutes</option>
                        <option value="30T">30 minutes</option>
                        <option value="1H" selected>1 heure</option>
                        <option value="3H">3 heures</option>
                        <option value="D">1 jour</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="weather-stations" class="form-label">Stations m√©t√©o :</label>
                    <input type="number" id="weather-stations" class="form-control" value="5" min="1" max="20">
                </div>
            </div>
            
            <div class="mt-3">
                <button id="btn-generate" class="btn btn-primary" disabled>
                    üîÑ G√©n√©rer les Donn√©es S√©lectionn√©es
                </button>
                <span id="generation-preview" class="ms-3 text-muted"></span>
            </div>
            <div id="generation-status" class="mt-3 hidden">
                <span class="status-indicator status-waiting"></span>
                <span id="generation-text">G√©n√©ration non d√©marr√©e</span>
            </div>
        </div>

        <!-- √âtape 3: Export des Donn√©es -->
        <div class="section-card">
            <h5><span class="step-number">3</span>Export des Fichiers Distincts</h5>
            
            <div class="alert alert-info">
                <strong>üìã Fichiers g√©n√©r√©s selon s√©lection :</strong><br>
                ‚Ä¢ <strong>M√©tadonn√©es B√¢timents</strong> : Informations OSM (toujours inclus)<br>
                ‚Ä¢ <strong>Consommation √âlectrique</strong> : S√©ries temporelles √©lectriques ‚ö°<br>
                ‚Ä¢ <strong>Consommation Eau</strong> : S√©ries temporelles d'eau üíß<br>
                ‚Ä¢ <strong>Simulation M√©t√©o</strong> : Donn√©es m√©t√©orologiques (33 colonnes) üå§Ô∏è
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label for="export-format" class="form-label">Format d'export :</label>
                    <select id="export-format" class="form-select">
                        <option value="csv">CSV (Comma Separated)</option>
                        <option value="parquet">Parquet (Compressed)</option>
                        <option value="xlsx">Excel (XLSX)</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button id="btn-export" class="btn btn-primary" disabled>
                        üíæ Exporter les Fichiers
                    </button>
                </div>
            </div>
            
            <div id="export-status" class="mt-3 hidden">
                <span class="status-indicator status-waiting"></span>
                <span id="export-text">Export non d√©marr√©</span>
            </div>
            
            <!-- Zone des fichiers export√©s -->
            <div id="exported-files" class="export-grid hidden">
                <!-- Les cartes de fichiers seront g√©n√©r√©es ici -->
            </div>
        </div>

        <!-- Console de logs -->
        <div class="section-card">
            <h5>üìã Console de Logs</h5>
            <div id="log-console" class="log-container">
                <div class="text-muted">Application initialis√©e. En attente d'actions...</div>
            </div>
            <button id="btn-clear-logs" class="btn btn-outline-secondary btn-sm mt-2">
                üóëÔ∏è Effacer les logs
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet pour la cartographie -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // ============================================================================
        // VARIABLES GLOBALES
        // ============================================================================
        
        let appState = {
            zones: [],
            currentBuildings: 0,
            currentConsumption: 0,
            currentWeather: 0,
            currentWater: 0,
            selectedZone: null,
            map: null,
            buildingMarkers: [],
            mapVisible: false,
            allBuildings: [], // Stockage de tous les b√¢timents
            displayedBuildings: [], // B√¢timents actuellement affich√©s
            densityPercentage: 10 // Pourcentage de b√¢timents √† afficher
        };

        // ============================================================================
        // UTILITAIRES
        // ============================================================================
        
        function logMessage(message, type = 'info') {
            const logConsole = document.getElementById('log-console');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            };
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${typeIcon[type]} ${message}`;
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'dark'}`;
            
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            const textSpan = element.querySelector('span:last-child');
            
            // Reset classes
            indicator.className = 'status-indicator';
            indicator.classList.add(`status-${status}`);
            textSpan.textContent = text;
            
            element.classList.remove('hidden');
        }

        function updateCacheInfo() {
            const cacheInfo = document.getElementById('cache-info');
            const parts = [`${appState.currentBuildings} b√¢timents`];
            
            if (appState.currentConsumption > 0) {
                parts.push(`${appState.currentConsumption} points √©lectricit√©`);
            }
            if (appState.currentWater > 0) {
                parts.push(`${appState.currentWater} points eau`);
            }
            if (appState.currentWeather > 0) {
                parts.push(`${appState.currentWeather} points m√©t√©o`);
            }
            
            cacheInfo.textContent = parts.join(', ');
        }

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                logMessage(`Erreur API ${url}: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============================================================================
        // INITIALISATION
        // ============================================================================
        
        async function initializeApp() {
            logMessage('Initialisation de l\'application...');
            
            try {
                // V√©rifier le statut
                const status = await apiCall('/api/status');
                
                updateStatus('app-status', 'success', `Application v${status.version} active`);
                
                // Mettre √† jour le cache
                appState.currentBuildings = status.cache.buildings_loaded;
                appState.currentConsumption = status.cache.consumption_points;
                appState.currentWeather = status.cache.weather_points;
                appState.currentWater = status.cache.water_points || 0;
                updateCacheInfo();
                
                // Charger les zones
                await loadZones();
                
                logMessage('‚úÖ Application initialis√©e avec succ√®s', 'success');
                
            } catch (error) {
                updateStatus('app-status', 'error', 'Erreur d\'initialisation');
                logMessage(`Erreur initialisation: ${error.message}`, 'error');
            }
        }

        async function loadZones() {
            try {
                logMessage('üìç Chargement des zones Malaysia...');
                
                const data = await apiCall('/api/zones');
                appState.zones = data.zones;
                
                const zoneSelect = document.getElementById('zone-select');
                zoneSelect.innerHTML = '<option value="">-- S√©lectionner une zone --</option>';
                
                data.zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.id;
                    option.textContent = zone.name;
                    zoneSelect.appendChild(option);
                });
                
                logMessage(`‚úÖ ${data.total_zones} zones charg√©es`, 'success');
                
            } catch (error) {
                logMessage('‚ùå Erreur chargement zones', 'error');
            }
        }

        // ============================================================================
        // GESTION DES √âV√âNEMENTS
        // ============================================================================
        
        document.getElementById('zone-select').addEventListener('change', function() {
            const selectedZone = this.value;
            appState.selectedZone = selectedZone;
            
            const btnLoadBuildings = document.getElementById('btn-load-buildings');
            btnLoadBuildings.disabled = !selectedZone;
            
            if (selectedZone) {
                logMessage(`üó∫Ô∏è Zone s√©lectionn√©e: ${this.options[this.selectedIndex].text}`);
            }
        });

        document.getElementById('btn-load-buildings').addEventListener('click', async function() {
            if (!appState.selectedZone) return;
            
            this.disabled = true;
            updateStatus('buildings-status', 'loading', 'Chargement des b√¢timents OSM...');
            logMessage(`üè¢ Chargement des b√¢timents pour: ${appState.selectedZone}`);
            
            try {
                const data = await apiCall(`/api/buildings/${appState.selectedZone}`, {
                    method: 'POST'
                });
                
                if (data.success) {
                    appState.currentBuildings = data.metadata.building_count;
                    appState.allBuildings = data.buildings || [];
                    updateCacheInfo();
                    
                    updateStatus('buildings-status', 'success', 
                        `${data.metadata.building_count} b√¢timents charg√©s en ${data.metadata.load_time_seconds.toFixed(1)}s`);
                    
                    logMessage(`‚úÖ ${data.metadata.building_count} b√¢timents OSM charg√©s`, 'success');
                    
                    // Affichage intelligent sur la carte
                    displayBuildingsIntelligently(appState.allBuildings, appState.selectedZone);
                    
                    // Activer la g√©n√©ration
                    validateGenerationOptions();
                    
                } else {
                    throw new Error(data.error);
                }
                
            } catch (error) {
                updateStatus('buildings-status', 'error', 'Erreur chargement b√¢timents');
                logMessage(`‚ùå Erreur chargement: ${error.message}`, 'error');
                
            } finally {
                this.disabled = false;
            }
        });

        // Gestionnaires cartographie
        document.getElementById('btn-toggle-map').addEventListener('click', toggleMapVisibility);
        document.getElementById('density-slider').addEventListener('input', updateDensityDisplay);
        document.getElementById('btn-refresh-map').addEventListener('click', refreshMapWithDensity);

        // ============================================================================
        // GESTION CARTOGRAPHIE INTELLIGENTE
        // ============================================================================
        
        function initializeMap() {
            if (appState.map) {
                appState.map.remove();
            }
            
            // Centr√© sur la Malaysia
            appState.map = L.map('osm-map').setView([4.2105, 101.9758], 6);
            
            // Tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(appState.map);
            
            // L√©gende
            addMapLegend();
            
            logMessage('üó∫Ô∏è Carte initialis√©e', 'info');
        }
        
        function addMapLegend() {
            const legend = L.control({position: 'bottomleft'});
            
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info legend');
                div.innerHTML = `
                    <div style="background: rgba(255,255,255,0.9); padding: 8px; border-radius: 5px; font-size: 0.8rem;">
                        <h6 style="margin-bottom: 5px; font-size: 0.9rem;">Types de B√¢timents</h6>
                        <div><span style="color: #28a745;">‚óè</span> R√©sidentiel</div>
                        <div><span style="color: #007bff;">‚óè</span> Commercial</div>
                        <div><span style="color: #6f42c1;">‚óè</span> Bureau</div>
                        <div><span style="color: #fd7e14;">‚óè</span> Industriel</div>
                        <div><span style="color: #20c997;">‚óè</span> √âcole</div>
                        <div><span style="color: #dc3545;">‚óè</span> H√¥pital</div>
                    </div>
                `;
                return div;
            };
            
            legend.addTo(appState.map);
        }
        
        function displayBuildingsIntelligently(buildings, zoneName) {
            if (!buildings || buildings.length === 0) {
                logMessage('‚ö†Ô∏è Aucun b√¢timent √† afficher sur la carte', 'warning');
                return;
            }
            
            // Toujours afficher la carte maintenant, mais avec √©chantillonnage intelligent
            document.getElementById('map-container').classList.remove('hidden');
            
            // Initialiser la carte si n√©cessaire
            if (!appState.map) {
                initializeMap();
            }
            
            // Appliquer l'√©chantillonnage
            refreshMapWithDensity();
            
            appState.mapVisible = true;
            
            logMessage(`üó∫Ô∏è Carte affich√©e avec √©chantillonnage intelligent`, 'success');
        }
        
        function sampleBuildings(buildings, percentage) {
            if (percentage >= 100) {
                return buildings;
            }
            
            const sampleSize = Math.max(1, Math.floor(buildings.length * (percentage / 100)));
            const step = Math.max(1, Math.floor(buildings.length / sampleSize));
            
            const sampled = [];
            for (let i = 0; i < buildings.length; i += step) {
                if (sampled.length < sampleSize) {
                    sampled.push(buildings[i]);
                }
            }
            
            return sampled;
        }
        
        function displayBuildingsOnMap(buildings) {
            // Nettoyer les marqueurs existants
            clearMapMarkers();
            
            if (!buildings || buildings.length === 0) {
                return;
            }
            
            // Couleurs par type de b√¢timent
            const buildingColors = {
                'residential': '#28a745',
                'commercial': '#007bff', 
                'office': '#6f42c1',
                'industrial': '#fd7e14',
                'school': '#20c997',
                'hospital': '#dc3545'
            };
            
            let bounds = [];
            let validBuildings = 0;
            
            // Ajouter les marqueurs
            for (const building of buildings) {
                if (building.latitude && building.longitude) {
                    const lat = parseFloat(building.latitude);
                    const lon = parseFloat(building.longitude);
                    
                    // V√©rification coordonn√©es valides
                    if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                        const color = buildingColors[building.building_type] || '#6c757d';
                        
                        // Cr√©er marqueur personnalis√©
                        const marker = L.circleMarker([lat, lon], {
                            radius: 3,
                            fillColor: color,
                            color: 'white',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                        
                        // Popup avec informations
                        const popupContent = `
                            <div style="font-size: 0.9rem; min-width: 180px;">
                                <h6 style="margin-bottom: 8px; color: ${color};">${building.building_type.charAt(0).toUpperCase() + building.building_type.slice(1)}</h6>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.8rem;">
                                    <span><strong>ID:</strong></span>
                                    <span>${(building.id || building.building_id || 'N/A').slice(0, 8)}...</span>
                                    <span><strong>Surface:</strong></span>
                                    <span>${building.surface_area_m2?.toFixed(1) || 'N/A'} m¬≤</span>
                                    <span><strong>Zone:</strong></span>
                                    <span>${building.zone_name || 'N/A'}</span>
                                </div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        marker.addTo(appState.map);
                        appState.buildingMarkers.push(marker);
                        
                        bounds.push([lat, lon]);
                        validBuildings++;
                    }
                }
            }
            
            // Ajuster la vue sur les b√¢timents
            if (bounds.length > 0) {
                appState.map.fitBounds(bounds, {padding: [20, 20]});
            }
            
            // Mettre √† jour le compteur
            document.getElementById('map-building-count').textContent = 
                `${validBuildings} / ${appState.allBuildings.length} b√¢timents`;
            
            appState.displayedBuildings = buildings;
            
            logMessage(`üó∫Ô∏è Carte mise √† jour: ${validBuildings} marqueurs affich√©s`, 'success');
        }
        
        function clearMapMarkers() {
            if (appState.buildingMarkers.length > 0) {
                appState.buildingMarkers.forEach(marker => {
                    appState.map.removeLayer(marker);
                });
                appState.buildingMarkers = [];
            }
        }
        
        function toggleMapVisibility() {
            const mapContainer = document.getElementById('map-container');
            const toggleBtn = document.getElementById('btn-toggle-map');
            
            if (appState.mapVisible) {
                mapContainer.style.display = 'none';
                toggleBtn.textContent = 'üëÅÔ∏è Afficher la carte';
                appState.mapVisible = false;
            } else {
                mapContainer.style.display = 'block';
                toggleBtn.textContent = 'üëÅÔ∏è Masquer la carte';
                appState.mapVisible = true;
                
                // R√©initialiser la taille de la carte
                if (appState.map) {
                    setTimeout(() => {
                        appState.map.invalidateSize();
                    }, 100);
                }
            }
        }
        
        function updateDensityDisplay() {
            const slider = document.getElementById('density-slider');
            const valueDisplay = document.getElementById('density-value');
            appState.densityPercentage = parseInt(slider.value);
            valueDisplay.textContent = `${appState.densityPercentage}%`;
        }
        
        function refreshMapWithDensity() {
            if (!appState.allBuildings || appState.allBuildings.length === 0) {
                return;
            }
            
            // √âchantillonnage des b√¢timents selon la densit√©
            const sampledBuildings = sampleBuildings(appState.allBuildings, appState.densityPercentage);
            
            logMessage(`üéØ Affichage de ${sampledBuildings.length} b√¢timents (${appState.densityPercentage}% du total)`, 'info');
            
            // Afficher sur la carte
            displayBuildingsOnMap(sampledBuildings);
        }

        // ============================================================================
        // GESTION G√âN√âRATION DE DONN√âES
        // ============================================================================
        
        const checkboxes = ['generate-electricity', 'generate-water', 'generate-weather'];
        
        checkboxes.forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                updateGenerationPreview();
                validateGenerationOptions();
            });
        });

        function updateGenerationPreview() {
            const electricity = document.getElementById('generate-electricity').checked;
            const water = document.getElementById('generate-water').checked;
            const weather = document.getElementById('generate-weather').checked;
            
            const selected = [];
            if (electricity) selected.push('‚ö° √âlectricit√©');
            if (water) selected.push('üíß Eau');
            if (weather) selected.push('üå§Ô∏è M√©t√©o');
            
            const preview = document.getElementById('generation-preview');
            if (selected.length > 0) {
                preview.textContent = `G√©n√©rera: ${selected.join(', ')}`;
                preview.className = 'ms-3 text-success';
            } else {
                preview.textContent = 'Aucun type s√©lectionn√©';
                preview.className = 'ms-3 text-danger';
            }
        }

        function validateGenerationOptions() {
            const electricity = document.getElementById('generate-electricity').checked;
            const water = document.getElementById('generate-water').checked;
            const weather = document.getElementById('generate-weather').checked;
            
            const hasSelection = electricity || water || weather;
            const btnGenerate = document.getElementById('btn-generate');
            
            // Le bouton est activ√© si on a des b√¢timents ET au moins une s√©lection
            const hasBuildings = appState.currentBuildings > 0;
            btnGenerate.disabled = !(hasBuildings && hasSelection);
            
            return hasSelection;
        }

        document.getElementById('btn-generate').addEventListener('click', async function() {
            if (appState.currentBuildings === 0) {
                logMessage('‚ö†Ô∏è Aucun b√¢timent charg√©', 'warning');
                return;
            }
            
            if (!validateGenerationOptions()) {
                logMessage('‚ö†Ô∏è S√©lectionnez au moins un type de donn√©es √† g√©n√©rer', 'warning');
                return;
            }
            
            this.disabled = true;
            updateStatus('generation-status', 'loading', 'G√©n√©ration en cours...');
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const frequency = document.getElementById('frequency').value;
            const weatherStations = parseInt(document.getElementById('weather-stations').value);
            
            // Validation des dates
            if (!startDate || !endDate) {
                logMessage('‚ùå Dates de d√©but et fin requises', 'error');
                updateStatus('generation-status', 'error', 'Dates manquantes');
                this.disabled = false;
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                logMessage('‚ùå La date de fin doit √™tre apr√®s la date de d√©but', 'error');
                updateStatus('generation-status', 'error', 'Plage de dates invalide');
                this.disabled = false;
                return;
            }
            
            // R√©cup√©ration des choix utilisateur
            const generateElectricity = document.getElementById('generate-electricity').checked;
            const generateWater = document.getElementById('generate-water').checked;
            const generateWeather = document.getElementById('generate-weather').checked;
            
            const selectedTypes = [];
            if (generateElectricity) selectedTypes.push('√©lectricit√©');
            if (generateWater) selectedTypes.push('eau');
            if (generateWeather) selectedTypes.push('m√©t√©o');
            
            logMessage(`üîÑ G√©n√©ration: ${startDate} ‚Üí ${endDate} (${frequency})`, 'info');
            logMessage(`üìä Types s√©lectionn√©s: ${selectedTypes.join(', ')}`, 'info');
            if (generateWeather) {
                logMessage(`üå§Ô∏è ${weatherStations} stations m√©t√©o`, 'info');
            }
            
            try {
                const data = await apiCall('/api/generate', {
                    method: 'POST',
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        frequency: frequency,
                        weather_stations: weatherStations,
                        generate_electricity: generateElectricity,
                        generate_water: generateWater,
                        generate_weather: generateWeather
                    })
                });
                
                if (data.success) {
                    // Mise √† jour du cache
                    if (data.summary.consumption_points) {
                        appState.currentConsumption = data.summary.consumption_points;
                    }
                    if (data.summary.weather_points) {
                        appState.currentWeather = data.summary.weather_points;
                    }
                    if (data.summary.water_points) {
                        appState.currentWater = data.summary.water_points || 0;
                    }
                    updateCacheInfo();
                    
                    // Message de succ√®s personnalis√©
                    const generatedTypes = [];
                    if (data.summary.consumption_points > 0) generatedTypes.push(`${data.summary.consumption_points} points √©lectricit√©`);
                    if (data.summary.water_points > 0) generatedTypes.push(`${data.summary.water_points} points eau`);
                    if (data.summary.weather_points > 0) generatedTypes.push(`${data.summary.weather_points} points m√©t√©o`);
                    
                    updateStatus('generation-status', 'success', 
                        `‚úÖ G√©n√©r√©: ${generatedTypes.join(', ')}`);
                    
                    logMessage(`‚úÖ Donn√©es g√©n√©r√©es: ${generatedTypes.join(', ')}`, 'success');
                    
                    // Activer l'export
                    document.getElementById('btn-export').disabled = false;
                    
                } else {
                    throw new Error(data.error);
                }
                
            } catch (error) {
                updateStatus('generation-status', 'error', 'Erreur g√©n√©ration');
                logMessage(`‚ùå Erreur g√©n√©ration: ${error.message}`, 'error');
                
            } finally {
                this.disabled = false;
            }
        });

        // ============================================================================
        // GESTION EXPORT
        // ============================================================================

        document.getElementById('btn-export').addEventListener('click', async function() {
            const hasData = (appState.currentConsumption > 0 || 
                           appState.currentWeather > 0 || 
                           appState.currentWater > 0);
            
            if (!hasData) {
                logMessage('‚ö†Ô∏è Aucune donn√©e √† exporter', 'warning');
                return;
            }
            
            this.disabled = true;
            updateStatus('export-status', 'loading', 'Export des fichiers en cours...');
            
            const exportFormat = document.getElementById('export-format').value;
            const timestamp = new Date().toISOString().slice(0,16).replace(/[:-]/g, '');
            
            logMessage(`üíæ Export en format ${exportFormat.toUpperCase()}...`);
            
            try {
                const data = await apiCall('/api/export', {
                    method: 'POST',
                    body: JSON.stringify({
                        format: exportFormat,
                        filename: `malaysia_electricity_${timestamp}`
                    })
                });
                
                if (data.success) {
                    updateStatus('export-status', 'success', 
                        `‚úÖ ${data.metadata.total_files} fichiers export√©s (${data.metadata.total_size_mb}MB)`);
                    
                    logMessage(`‚úÖ Export r√©ussi: ${data.metadata.total_files} fichiers (${data.metadata.total_size_mb}MB)`, 'success');
                    
                    // Afficher les fichiers
                    displayExportedFiles(data.files);
                    
                } else {
                    throw new Error(data.error);
                }
                
            } catch (error) {
                updateStatus('export-status', 'error', 'Erreur export');
                logMessage(`‚ùå Erreur export: ${error.message}`, 'error');
                
            } finally {
                this.disabled = false;
            }
        });

        function displayExportedFiles(files) {
            const exportedFiles = document.getElementById('exported-files');
            exportedFiles.innerHTML = '';
            exportedFiles.classList.remove('hidden');
            
            files.forEach(file => {
                const fileCard = document.createElement('div');
                fileCard.className = 'export-card';
                
                const typeIcons = {
                    'buildings_metadata': 'üè¢',
                    'electricity_consumption': '‚ö°',
                    'water_consumption': 'üíß',
                    'weather_simulation': 'üå§Ô∏è'
                };
                
                const typeNames = {
                    'buildings_metadata': 'M√©tadonn√©es B√¢timents',
                    'electricity_consumption': 'Consommation √âlectrique',
                    'water_consumption': 'Consommation Eau',
                    'weather_simulation': 'Simulation M√©t√©o'
                };
                
                fileCard.innerHTML = `
                    <div class="mb-2">
                        <span style="font-size: 2em;">${typeIcons[file.type] || 'üìÑ'}</span>
                    </div>
                    <h6>${typeNames[file.type] || file.type}</h6>
                    <p class="text-muted mb-2">
                        ${file.records.toLocaleString()} enregistrements<br>
                        ${file.size_mb.toFixed(2)} MB
                    </p>
                    <a href="/api/download/${file.name}" class="btn btn-outline-primary btn-sm">
                        üì• T√©l√©charger
                    </a>
                `;
                
                exportedFiles.appendChild(fileCard);
            });
        }

        // ============================================================================
        // AUTRES GESTIONNAIRES
        // ============================================================================

        document.getElementById('btn-clear-logs').addEventListener('click', function() {
            const logConsole = document.getElementById('log-console');
            logConsole.innerHTML = '<div class="text-muted">Console effac√©e...</div>';
        });

        // ============================================================================
        // INITIALISATION AU CHARGEMENT
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('üîÑ Chargement de la page termin√©');
            initializeApp();
            
            // Initialisation des pr√©visualisations
            updateGenerationPreview();
            validateGenerationOptions();
            updateDensityDisplay();
        });

        // Nettoyage lors de la fermeture de la page
        window.addEventListener('beforeunload', function() {
            if (appState.map) {
                clearMapMarkers();
                appState.map.remove();
            }
        });

        // Mise √† jour automatique du statut toutes les 30 secondes
        setInterval(async function() {
            try {
                const status = await apiCall('/api/status');
                appState.currentBuildings = status.cache.buildings_loaded;
                appState.currentConsumption = status.cache.consumption_points;
                appState.currentWeather = status.cache.weather_points;
                appState.currentWater = status.cache.water_points || 0;
                updateCacheInfo();
            } catch (error) {
                // Ignore silently
            }
        }, 30000);
    </script>
</body>
</html>